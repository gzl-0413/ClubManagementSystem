@model IPagedList<ClubManagementSystem.Models.Member>
@using X.PagedList
@using X.PagedList.Mvc.Core

@{
    Layout = "_Layout";
    ViewBag.Title = "Member Management Page";
}

<style>
    body, table, th, td {
        color: black !important; /* Set text color to black */
    }

    th {
        color: black !important; /* Ensure the table headers are black */
    }
</style>

<div class="container mt-4">

    <!-- TempData Alerts -->
    @if (TempData["Info"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Success!</strong> @TempData["Info"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error!</strong> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <p class="mb-4">Manage the details of all members here. You can add, edit, or delete member accounts.</p>

    <!-- Search Input -->
    <div class="d-flex mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Search by name or email" onkeyup="searchMembers()" />
    </div>

    <!-- Sorting Dropdowns -->
    <div class="d-flex mb-3">
        <select id="sort" class="form-select ms-2" onchange="sortMembers()">
            <option value="Email">Email</option>
            <option value="Name">Name</option>
            <option value="CreatedAt">Created At</option>
        </select>

        <select id="dir" class="form-select ms-2" onchange="sortMembers()">
            <option value="asc">Ascending</option>
            <option value="desc">Descending</option>
        </select>
    </div>

    <!-- Member List Table -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Member List</h3>
        </div>
        <div class="card-body">
            <table class="table table-striped table-bordered" id="memberTable">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Name</th>
                        <th>Created At</th>
                        <th>Is Activated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var member in Model)
                    {
                        <tr class="memberRow">
                            <td>@member.Email</td>
                            <td>@member.Name</td>
                            <td>@member.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            <td>
                                @if (member.IsActivated)
                                {
                                    <span class="badge bg-success">Yes</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">No</span>
                                }
                            </td>
                            <td>
                                <!-- Edit Button -->
                                <a asp-action="MemberEdit" asp-route-email="@member.Email" class="btn btn-primary btn-sm">Edit</a>

                                <!-- Delete Form -->
                                <form asp-action="DeleteMember" method="post" style="display:inline;">
                                    <input type="hidden" name="email" value="@member.Email" />
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this member?')">Delete</button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="mt-3">
        <ul class="pagination">
            @for (int i = 1; i <= Model.PageCount; i++)
            {
                <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                    <a class="page-link" href="@Url.Action("MemberPage", new { name = ViewBag.Name, sort = ViewBag.Sort, dir = ViewBag.Dir, page = i })">@i</a>
                </li>
            }
        </ul>
    </div>

</div>

<!-- Bootstrap JS for Alerts -->
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // Search function for members
        function searchMembers() {
            var input = document.getElementById('searchInput').value.toLowerCase();
            var table = document.getElementById('memberTable');
            var rows = table.getElementsByClassName('memberRow');

            for (var i = 0; i < rows.length; i++) {
                var email = rows[i].getElementsByTagName('td')[0].textContent.toLowerCase();
                var name = rows[i].getElementsByTagName('td')[1].textContent.toLowerCase();

                if (email.includes(input) || name.includes(input)) {
                    rows[i].style.display = ''; // Show row
                } else {
                    rows[i].style.display = 'none'; // Hide row
                }
            }
        }

        // Sorting function for members (client-side sorting)
        function sortMembers() {
            var sort = document.getElementById('sort').value;
            var dir = document.getElementById('dir').value;

            var table = document.getElementById('memberTable');
            var rows = Array.from(table.getElementsByClassName('memberRow'));

            rows.sort(function(a, b) {
                var cellA = a.getElementsByTagName('td')[getColumnIndex(sort)].textContent;
                var cellB = b.getElementsByTagName('td')[getColumnIndex(sort)].textContent;

                if (sort === 'CreatedAt') {
                    // Convert string dates to Date objects for comparison
                    cellA = new Date(cellA);
                    cellB = new Date(cellB);
                } else if (sort === 'IsActivated') {
                    // Sort based on activation status (Yes/No)
                    cellA = cellA === "Yes" ? 1 : 0;
                    cellB = cellB === "Yes" ? 1 : 0;
                }

                if (dir === 'asc') {
                    return cellA > cellB ? 1 : (cellA < cellB ? -1 : 0);
                } else {
                    return cellA < cellB ? 1 : (cellA > cellB ? -1 : 0);
                }
            });

            // Re-render rows
            rows.forEach(row => table.appendChild(row));
        }

        // Helper function to get the column index based on selected sorting option
        function getColumnIndex(sort) {
            switch (sort) {
                case 'Email': return 0;
                case 'Name': return 1;
                case 'CreatedAt': return 2;
                default: return 0;
            }
        }

    </script>
}
