@model FacilityBookingViewModel
@{
    ViewBag.Title = "Facility Booking";
}

<form method="post" class="form">
    <div asp-validation-summary="ModelOnly"></div>

    <label asp-for="Name">User Name</label>
    <input id="UserName" asp-for="Name">
    <span asp-validation-for="Name"></span>

    <label asp-for="PhoneNumber">Phone Number</label>
    <input id="PhoneNumber" asp-for="PhoneNumber" placeholder="e.g. 0123456789">
    <span asp-validation-for="PhoneNumber"></span>

    <label asp-for="Email">User Email</label>
    <input id="UserEmail"
           data-url="@Url.Action("GetEmails", "FacilityBooking")"
           autocomplete="off" asp-for="Email">
    <div id="emailSuggestions" class="list-group mt-2"></div>

    <label asp-for="FacilityId">Facility</label>
    <select id="FacilityId" asp-for="FacilityId">
        <option value="">Select Facility</option>
        @foreach (var facility in ViewBag.Facilities)
        {
            <option value="@facility.Id">@facility.Name</option>
        }
    </select>

    <label asp-for="BookingDate">Booking Date</label>
    <input type="date" id="BookingDate" asp-for="BookingDate">
    <span asp-validation-for="BookingDate"></span>

    <label asp-for="StartTime">Start Time</label>
    <input type="time" id="StartTime" asp-for="StartTime" step="3600" min="08:00" max="22:00">
    <span asp-validation-for="StartTime"></span>

    <label asp-for="EndTime">End Time</label>
    <input type="time" id="EndTime" asp-for="EndTime" step="3600" min="08:00" max="22:00">
    <span asp-validation-for="EndTime"></span>

    <label asp-for="FeePaid">Fee Paid (RM)</label>
    <input type="number" step="0.01" asp-for="FeePaid" id="FeePaid">
    <small class="text-muted" id="calculatedFee">Calculated Fee: RM 0.00</small>

    <label asp-for="PayBy">Payment Method</label>
    <select asp-for="PayBy">
        @foreach (var method in ViewBag.PaymentMethods)
        {
            <option value="@method">@method</option>
        }
    </select>

    <button type="submit">Submit Booking</button>
</form>

@section scripts {
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            // Disable past dates and unavailable dates
            $('#BookingDate').on('input', function () {
                var selectedDate = $(this).val();
                var today = new Date().toISOString().split('T')[0];

                // Check if the selected date is past or unavailable
                if (selectedDate < today) {
                    alert('This date is not available for booking!');
                    $(this).val('');  // Reset the date picker
                }
            });

            // Disable past dates in date picker
            $('#BookingDate').attr('min', new Date().toISOString().split('T')[0]);

            let timer = null;

            // AJAX Email Search
            $('#UserEmail').on('input', function () {
                clearTimeout(timer);
                let email = $(this).val();
                let url = $(this).data('url');

                if (email.length > 2) {
                    timer = setTimeout(() => {
                        $.get(url, { term: email }, function (data) {
                            let suggestions = $('#emailSuggestions');
                            suggestions.empty();
                            if (data.length > 0) {
                                data.forEach(user => {
                                    suggestions.append(`<div class="list-group-item list-group-item-action"
                                        data-email="${user.email}"
                                        data-name="${user.name}">${user.email} - ${user.name}</div>`);
                                });
                            }
                        });
                    }, 100);
                } else {
                    $('#emailSuggestions').empty();
                }
            });

            // Fill in selected email and user name
            $('#emailSuggestions').on('click', '.list-group-item', function () {
                let selectedEmail = $(this).data('email');
                let selectedName = $(this).data('name');

                $('#UserEmail').val(selectedEmail);
                $('#UserName').val(selectedName);

                $('#emailSuggestions').empty();
            });

            function calculateFee() {
                let facilityId = $('#FacilityId').val();
                let bookingDate = $('#BookingDate').val();
                let startTime = $('#StartTime').val();
                let endTime = $('#EndTime').val();
                let email = $('#UserEmail').val();

                if (facilityId && bookingDate && startTime && endTime && email) {
                    $.get('@Url.Action("CalculateFee", "FacilityBooking")', {
                        facilityId, bookingDate, startTime, endTime, email
                    }, function (data) {
                        if (data.fee !== undefined) {
                            $('#calculatedFee').text(`Calculated Fee: RM ${data.fee.toFixed(2)}`);
                            $('#FeePaid').val(data.fee);
                        } else {
                            $('#calculatedFee').text(`Error: ${data.error}`);
                        }
                    });
                }
            }

            $('#FacilityId, #BookingDate, #StartTime, #EndTime, #UserEmail').on('change input', calculateFee);

            // Restrict time to hourly intervals and disable past times
            function restrictTime(inputId) {
                let input = document.getElementById(inputId);

                input.addEventListener('input', function () {
                    let now = new Date();
                    let selectedDate = $('#BookingDate').val();
                    let time = input.value;

                    if (time && selectedDate) {
                        let selectedDateTime = new Date(`${selectedDate}T${time}`);

                        // Disable past times on the current day
                        if (selectedDateTime <= now) {
                            alert('Selected time is in the past. Please choose a future time.');
                            input.value = '';
                        }
                    }
                });
            }

            restrictTime('StartTime');
            restrictTime('EndTime');

        $('#StartTime, #EndTime').on('change', function () {
                let time = this.value; // Time in 24-hour format (HH:mm)
                if (time) {
                    let [hour, minute] = time.split(':').map(Number);

                    // Convert to 12-hour format
                    let period = hour >= 12 ? 'PM' : 'AM';
                    hour = hour % 12 || 12; // Convert 0 -> 12 for AM

                    let formattedTime = `${hour}:${minute.toString().padStart(2, '0')} ${period}`;
                    console.log(`Selected Time: ${formattedTime}`); // Display for debugging
                }
            });
        });
    </script>
}
